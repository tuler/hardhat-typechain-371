# Type

This project demonstrates an issue regarding using [TypeChain](https://github.com/dethcrypto/TypeChain) generated code inside hardhat [tasks](https://hardhat.org/guides/create-task.html), documented at [issue 371](https://github.com/dethcrypto/TypeChain/issues/371).

This project use [hardhat-deploy](https://github.com/wighawag/hardhat-deploy) to deploy the simple `Greeter` contract, and creates a task called `hello` that calls the `greet` function of the deployed contract.

Everything is implemented in TypeScript.
To run the project open a shell and run:

    npx hardhat node

From another shell run the task

    npx hardhat hello

It should print: `Hello, world!`

The task uses code generated by TypeChain, written to the directory `typechain-types`, and excluded in `.gitignore`.
TypeChain is executed automatically by the `@typechain/hardhat` plugin, in the hardhat compilation phase. As stated in the documentation it tries to generate code only when a contract changes.

The TypeScript code of the application is compiled by running `npx tsc`. Compilation is guided by the configuration at `tsconfig.json`, which includes the task code and the generated TypeChain code.

To clean up the TypeChain generated code we can call the following hardhat task, which cleans up the compiled contracts, and also the TypeChain code.

    npx hardhat clean

After that if we run the Typescript compilation we get the following expected error:

    src/tasks/index.ts:4:34 - error TS2307: Cannot find module '../../typechain-types' or its corresponding type declarations.

    4 import { Greeter__factory } from "../../typechain-types";
                                       ~~~~~~~~~~~~~~~~~~~~~~~


    Found 1 error.

Then if we try to trigger the TypeChain code generation, we run `npx hardhat compile`. We still get the following error:

    An unexpected error occurred:

    src/tasks/index.ts:4:34 - error TS2307: Cannot find module '../../typechain-types' or its corresponding type declarations.

    4 import { Greeter__factory } from "../../typechain-types";
                                       ~~~~~~~~~~~~~~~~~~~~~~~

This happens because the `src/tasks/index.ts` file is included by `hardhat.config.ts`, which is the first file hardhat loads to bootstrap itself, to then try to compile the project. Running `npx hardhat typechain` does not work either.

The issue mentioned above suggests a workaround to run the following command instead:

    TS_NODE_TRANSPILE_ONLY=1 npx hardhat typechain

At least for me it does not work as well, with the following error:

    An unexpected error occurred:

    Error: Cannot find module '../../typechain-types'
    Require stack:
    - /Users/tuler/Documents/workspace/test/hardhat-typechain-test/src/tasks/index.ts
    - /Users/tuler/Documents/workspace/test/hardhat-typechain-test/hardhat.config.ts
    - /Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/hardhat/internal/core/config/config-loading.js
    - /Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/hardhat/internal/cli/cli.js
        at Function.Module._resolveFilename (node:internal/modules/cjs/loader:933:15)
        at Function.Module._resolveFilename.sharedData.moduleResolveFilenameHook.installedValue [as _resolveFilename] (/Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/@cspotcode/source-map-support/source-map-support.js:679:30)
        at Function.Module._load (node:internal/modules/cjs/loader:778:27)
        at Module.require (node:internal/modules/cjs/loader:1005:19)
        at require (node:internal/modules/cjs/helpers:102:18)
        at Object.<anonymous> (/Users/tuler/Documents/workspace/test/hardhat-typechain-test/src/tasks/index.ts:4:1)
        at Module._compile (node:internal/modules/cjs/loader:1101:14)
        at Module.m._compile (/Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/ts-node/src/index.ts:1371:23)
        at Module._extensions..js (node:internal/modules/cjs/loader:1153:10)
        at Object.require.extensions.<computed> [as .ts] (/Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/ts-node/src/index.ts:1374:12) {
    code: 'MODULE_NOT_FOUND',
    requireStack: [
        '/Users/tuler/Documents/workspace/test/hardhat-typechain-test/src/tasks/index.ts',
        '/Users/tuler/Documents/workspace/test/hardhat-typechain-test/hardhat.config.ts',
        '/Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/hardhat/internal/core/config/config-loading.js',
        '/Users/tuler/Documents/workspace/test/hardhat-typechain-test/node_modules/hardhat/internal/cli/cli.js'
    ]
    }
